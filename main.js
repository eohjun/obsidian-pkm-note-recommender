/*
THIS IS A GENERATED/BUNDLED FILE BY ESBUILD
PKM Note Recommender - https://github.com/eohjun/obsidian-pkm-note-recommender
*/

"use strict";var Q=Object.defineProperty;var he=Object.getOwnPropertyDescriptor;var fe=Object.getOwnPropertyNames;var ye=Object.prototype.hasOwnProperty;var b=(d,t)=>()=>(d&&(t=d(d=0)),t);var ce=(d,t)=>{for(var e in t)Q(d,e,{get:t[e],enumerable:!0})},be=(d,t,e,n)=>{if(t&&typeof t=="object"||typeof t=="function")for(let i of fe(t))!ye.call(d,i)&&i!==e&&Q(d,i,{get:()=>t[i],enumerable:!(n=he(t,i))||n.enumerable});return d};var ve=d=>be(Q({},"__esModule",{value:!0}),d);function h(d,t){if(d instanceof p)return d;let e=d instanceof Error?d.message:String(d),n=e.toLowerCase();if(t){if(t===429){let i=e.match(/retry.?after[:\s]+(\d+)/i),s=i?parseInt(i[1],10)*1e3:void 0;return new R(e,s)}if(t===401||t===403)return new L(e);if(t===503||t===502||t===504)return new N(e);if(t===400)return new z(e)}return n.includes("rate")||n.includes("429")||n.includes("too many")?new R(e):n.includes("401")||n.includes("403")||n.includes("unauthorized")||n.includes("invalid api key")?new L(e):n.includes("timeout")||n.includes("etimedout")||n.includes("timed out")?new j(e):n.includes("503")||n.includes("unavailable")?new N(e):new p(e,"UNKNOWN",!1)}var p,R,L,j,N,z,me=b(()=>{"use strict";p=class extends Error{constructor(e,n,i=!1){super(e);this.code=n;this.retryable=i;this.name="LLMError"}},R=class extends p{constructor(e="Rate limit exceeded",n){super(e,"RATE_LIMIT",!0);this.retryAfterMs=n;this.name="RateLimitError"}},L=class extends p{constructor(t="Invalid API key or unauthorized access"){super(t,"AUTH_ERROR",!1),this.name="AuthenticationError"}},j=class extends p{constructor(t="Request timed out"){super(t,"TIMEOUT",!0),this.name="TimeoutError"}},N=class extends p{constructor(t="Service temporarily unavailable"){super(t,"SERVICE_UNAVAILABLE",!0),this.name="ServiceUnavailableError"}},z=class extends p{constructor(t="Invalid request"){super(t,"INVALID_REQUEST",!1),this.name="InvalidRequestError"}}});var _=b(()=>{"use strict";me()});function xe(d){return new Promise(t=>setTimeout(t,d))}function Te(d,t,e,n,i){if(i&&i>0)return Math.min(i+500,e);let s=t*Math.pow(2,d),r=s*n*Math.random(),o=s+r;return Math.min(o,e)}function Ae(d){if(d instanceof p)return d.retryable;if(d instanceof Error){let t=d.message.toLowerCase();return t.includes("timeout")||t.includes("rate")||t.includes("429")||t.includes("503")||t.includes("network")||t.includes("econnreset")||t.includes("etimedout")}return!1}async function S(d,t={}){let e={...we,...t},n;for(let i=0;i<=e.maxRetries;i++)try{return await d()}catch(s){if(n=s instanceof Error?s:new Error(String(s)),i===e.maxRetries||!Ae(s))throw s;let r=s instanceof R?s.retryAfterMs:void 0,o=Te(i,e.baseDelayMs,e.maxDelayMs,e.jitterFactor,r);e.onRetry&&e.onRetry(i+1,o,n),await xe(o)}throw n??new Error("Retry failed with unknown error")}var we,H=b(()=>{"use strict";_();we={maxRetries:3,baseDelayMs:1e3,maxDelayMs:3e4,jitterFactor:.2}});var ee,te,f,F=b(()=>{"use strict";ee=require("obsidian");_();H();te={maxRetries:3,baseDelayMs:1e3,maxDelayMs:3e4,jitterFactor:.2},f=class{constructor(t,e,n){this.apiKey=t.apiKey,this.baseUrl=t.baseUrl??e,this.defaultModel=t.defaultModel??n,this.retryOptions=te}getDefaultModel(){return this.defaultModel}async makeRequest(t,e,n="POST",i={}){let s=`${this.baseUrl}${t}`;return S(async()=>{let o={"Content-Type":"application/json",...this.getAuthHeaders(),...i},a={url:s,method:n,headers:o,throw:!1};e&&n==="POST"&&(a.body=JSON.stringify(e));let c=await(0,ee.requestUrl)(a);if(c.status>=400){let l=c.json??{},m=this.extractErrorMessage(l,c.status);throw h(new Error(m),c.status)}return c.json},{...this.retryOptions,onRetry:(o,a,c)=>{console.warn(`[${this.providerType}] Retry attempt ${o} after ${a}ms: ${c.message}`)}})}async makeRequestNoRetry(t,e,n="POST",i={}){let s=`${this.baseUrl}${t}`,r={"Content-Type":"application/json",...this.getAuthHeaders(),...i},o={url:s,method:n,headers:r,throw:!1};e&&n==="POST"&&(o.body=JSON.stringify(e));let a=await(0,ee.requestUrl)(o);if(a.status>=400){let c=a.json??{},l=this.extractErrorMessage(c,a.status);throw h(new Error(l),a.status)}return a.json}getAuthHeaders(){return{Authorization:`Bearer ${this.apiKey}`}}extractErrorMessage(t,e){if(typeof t=="object"&&t!==null){let n=t;if(typeof n.error=="string")return n.error;if(typeof n.error=="object"&&n.error!==null){let i=n.error;if(typeof i.message=="string")return i.message}if(typeof n.message=="string")return n.message}return`API error: ${e}`}estimateTokens(t){let e=(t.match(/[\u3000-\u9fff\uac00-\ud7af]/g)||[]).length,n=t.length-e;return Math.ceil(e/2+n/4)}handleError(t){return h(t)}}});var Ie,ke,Me,C,ne=b(()=>{"use strict";F();Ie={"text-embedding-3-small":{dimensions:1536,maxTokens:8191},"text-embedding-3-large":{dimensions:3072,maxTokens:8191},"text-embedding-ada-002":{dimensions:1536,maxTokens:8191}},ke="text-embedding-3-small",Me="https://api.openai.com/v1",C=class extends f{constructor(e){super(e,Me,ke);this.providerType="openai"}isConfigured(){return!!(this.apiKey&&this.apiKey.startsWith("sk-"))}getAvailableModels(){return Object.keys(Ie)}async validateApiKey(){try{return await this.makeRequestNoRetry("/models",null,"GET"),!0}catch{return!1}}async generateEmbedding(e){let n=e.model??this.defaultModel,i=await this.makeRequest("/embeddings",{model:n,input:e.text});return{embedding:i.data[0].embedding,model:n,tokenCount:i.usage?.total_tokens??this.estimateTokens(e.text)}}async generateEmbeddings(e){let n=e.model??this.defaultModel,i=await this.makeRequest("/embeddings",{model:n,input:e.texts});return{embeddings:[...i.data].sort((r,o)=>r.index-o.index).map(r=>r.embedding),model:n,totalTokens:i.usage?.total_tokens??0}}async generateCompletion(e){let n="gpt-4o-mini",i=await this.makeRequest("/chat/completions",{model:n,messages:[{role:"system",content:"You are a helpful assistant that analyzes note connections in a PKM system. Always respond in JSON format when requested."},{role:"user",content:e.prompt}],max_tokens:e.maxTokens??200,temperature:e.temperature??.3});return{text:i.choices[0]?.message?.content??"",model:n,tokenCount:i.usage?.total_tokens??0}}extractErrorMessage(e,n){if(typeof e=="object"&&e!==null){let i=e;if(typeof i.error=="object"&&i.error!==null){let s=i.error;if(typeof s.message=="string")return`OpenAI API error: ${n} - ${s.message}`}}return`OpenAI API error: ${n}`}}});var ie,Le,Ne,_e,w,se=b(()=>{"use strict";ie=require("obsidian");F();_();H();Le={"text-embedding-004":{dimensions:768,maxTokens:2048},"embedding-001":{dimensions:768,maxTokens:2048}},Ne="text-embedding-004",_e="https://generativelanguage.googleapis.com/v1beta",w=class extends f{constructor(e){super(e,_e,Ne);this.providerType="gemini"}isConfigured(){return!!(this.apiKey&&this.apiKey.startsWith("AIza"))}getAvailableModels(){return Object.keys(Le)}async validateApiKey(){try{let e=`${this.baseUrl}/models?key=${this.apiKey}`;return(await(0,ie.requestUrl)({url:e,method:"GET",throw:!1})).status===200}catch{return!1}}async generateEmbedding(e){let n=e.model??this.defaultModel;return{embedding:(await this.makeGeminiRequest(`models/${n}:embedContent`,{content:{parts:[{text:e.text}]}})).embedding.values,model:n,tokenCount:this.estimateTokens(e.text)}}async generateEmbeddings(e){let n=e.model??this.defaultModel,i=e.texts.map(r=>({model:`models/${n}`,content:{parts:[{text:r}]}}));return{embeddings:(await this.makeGeminiRequest(`models/${n}:batchEmbedContents`,{requests:i})).embeddings.map(r=>r.values),model:n,totalTokens:e.texts.reduce((r,o)=>r+this.estimateTokens(o),0)}}async generateCompletion(e){let n="gemini-1.5-flash",i=await this.makeGeminiRequest(`models/${n}:generateContent`,{contents:[{parts:[{text:e.prompt}]}],generationConfig:{maxOutputTokens:e.maxTokens??200,temperature:e.temperature??.3}});return{text:i.candidates?.[0]?.content?.parts?.[0]?.text??"",model:n,tokenCount:i.usageMetadata?.totalTokenCount??0}}async makeGeminiRequest(e,n){let i=`${this.baseUrl}/${e}?key=${this.apiKey}`;return S(async()=>{let r={url:i,method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(n),throw:!1},o=await(0,ie.requestUrl)(r);if(o.status>=400){let a=o.json??{},c=this.extractGeminiError(a,o.status);throw h(new Error(c),o.status)}return o.json},{...this.retryOptions,onRetry:(r,o,a)=>{console.warn(`[gemini] Retry attempt ${r} after ${o}ms: ${a.message}`)}})}extractGeminiError(e,n){if(typeof e=="object"&&e!==null){let i=e;if(typeof i.error=="object"&&i.error!==null){let s=i.error;if(typeof s.message=="string")return`Gemini API error: ${n} - ${s.message}`}}return`Gemini API error: ${n}`}}});var re,Fe,De,Oe,$e,x,oe=b(()=>{"use strict";re=require("obsidian");F();_();H();Fe={"voyage-3":{dimensions:1024,maxTokens:32e3},"voyage-3-lite":{dimensions:512,maxTokens:32e3},"voyage-code-3":{dimensions:1024,maxTokens:32e3}},De="voyage-3-lite",Oe="https://api.voyageai.com/v1",$e="https://api.anthropic.com/v1",x=class extends f{constructor(e){super(e,Oe,De);this.providerType="anthropic"}isConfigured(){return!!(this.apiKey&&(this.apiKey.startsWith("pa-")||this.apiKey.includes("voyage")))}getAvailableModels(){return Object.keys(Fe)}async validateApiKey(){try{return await this.makeVoyageRequest("/embeddings",{model:this.defaultModel,input:"test",input_type:"document"}),!0}catch{return!1}}async generateEmbedding(e){let n=e.model??this.defaultModel,i=await this.makeVoyageRequest("/embeddings",{model:n,input:e.text,input_type:"document"});return{embedding:i.data[0].embedding,model:n,tokenCount:i.usage?.total_tokens??this.estimateTokens(e.text)}}async generateEmbeddings(e){let n=e.model??this.defaultModel,i=await this.makeVoyageRequest("/embeddings",{model:n,input:e.texts,input_type:"document"});return{embeddings:[...i.data].sort((r,o)=>r.index-o.index).map(r=>r.embedding),model:n,totalTokens:i.usage?.total_tokens??0}}async generateCompletion(e){if(!this.apiKey.startsWith("sk-ant-"))throw new Error("Text completion requires an Anthropic API key (sk-ant-*). Current key is for Voyage AI embeddings only.");let n="claude-3-haiku-20240307",i=await this.makeClaudeRequest("/messages",{model:n,max_tokens:e.maxTokens??200,messages:[{role:"user",content:e.prompt}]});return{text:i.content?.[0]?.text??"",model:n,tokenCount:(i.usage?.input_tokens??0)+(i.usage?.output_tokens??0)}}async makeVoyageRequest(e,n){let i=`${this.baseUrl}${e}`;return S(async()=>{let r={url:i,method:"POST",headers:{Authorization:`Bearer ${this.apiKey}`,"Content-Type":"application/json"},body:JSON.stringify(n),throw:!1},o=await(0,re.requestUrl)(r);if(o.status>=400){let a=o.json??{},c=this.extractVoyageError(a,o.status);throw h(new Error(c),o.status)}return o.json},{...this.retryOptions,onRetry:(r,o,a)=>{console.warn(`[voyage] Retry attempt ${r} after ${o}ms: ${a.message}`)}})}async makeClaudeRequest(e,n){let i=`${$e}${e}`;return S(async()=>{let r={url:i,method:"POST",headers:{"x-api-key":this.apiKey,"anthropic-version":"2023-06-01","Content-Type":"application/json"},body:JSON.stringify(n),throw:!1},o=await(0,re.requestUrl)(r);if(o.status>=400){let a=o.json??{},c=this.extractClaudeError(a,o.status);throw h(new Error(c),o.status)}return o.json},{...this.retryOptions,onRetry:(r,o,a)=>{console.warn(`[claude] Retry attempt ${r} after ${o}ms: ${a.message}`)}})}extractVoyageError(e,n){if(typeof e=="object"&&e!==null){let i=e;if(typeof i.detail=="string")return`Voyage AI error: ${n} - ${i.detail}`;if(typeof i.error=="string")return`Voyage AI error: ${n} - ${i.error}`}return`Voyage AI error: ${n}`}extractClaudeError(e,n){if(typeof e=="object"&&e!==null){let i=e;if(typeof i.error=="object"&&i.error!==null){let s=i.error;if(typeof s.message=="string")return`Anthropic API error: ${n} - ${s.message}`}}return`Anthropic API error: ${n}`}}});var ue={};ce(ue,{AnthropicAdapter:()=>x,BaseProvider:()=>f,GeminiAdapter:()=>w,LLM_PROVIDERS:()=>ae,LLM_RETRY_OPTIONS:()=>te,OpenAIAdapter:()=>C,createLLMProvider:()=>W,getDefaultModel:()=>Ue,validateApiKeyFormat:()=>de});function W(d,t){switch(d){case"openai":return new C(t);case"gemini":return new w(t);case"anthropic":return new x(t);default:throw new Error(`Unknown LLM provider type: ${d}`)}}function Ue(d){switch(d){case"openai":return"text-embedding-3-small";case"gemini":return"text-embedding-004";case"anthropic":return"voyage-3-lite";default:return""}}function de(d,t){if(!t)return!1;switch(d){case"openai":return t.startsWith("sk-");case"gemini":return t.startsWith("AIza");case"anthropic":return t.startsWith("pa-")||t.includes("voyage");default:return!1}}var ae,Y=b(()=>{"use strict";ne();se();oe();F();ne();se();oe();ae={openai:{name:"OpenAI",description:"GPT models and text-embedding-3 (recommended)",keyPrefix:"sk-",keyPlaceholder:"sk-...",docsUrl:"https://platform.openai.com/api-keys"},gemini:{name:"Google Gemini",description:"Gemini models with generous free tier",keyPrefix:"AIza",keyPlaceholder:"AIza...",docsUrl:"https://aistudio.google.com/apikey"},anthropic:{name:"Anthropic (Voyage AI)",description:"High-quality embeddings via Voyage AI",keyPrefix:"pa-",keyPlaceholder:"pa-... (Voyage AI key)",docsUrl:"https://www.voyageai.com/"}}});var Be={};ce(Be,{default:()=>X});module.exports=ve(Be);var y=require("obsidian");var U=class{constructor(t,e){this.noteRepository=t;this.graphRepository=e;this.embeddingService=null}setEmbeddingService(t){this.embeddingService=t}async execute(t){let{sourceNoteId:e,maxResults:n=10,useGraphConnections:i=!1,useSemanticSimilarity:s=!1,semanticThreshold:r=.5,minScore:o=0}=t,a=await this.noteRepository.findById(e);if(!a)return{success:!1,recommendations:[],sourceNoteId:e,error:"Source note not found"};let c=new Map;return await this.addTagBasedRecommendations(a,c),i&&await this.addGraphBasedRecommendations(a,c),s&&this.embeddingService?.isReady()&&await this.addSemanticRecommendations(a,c,r,n),{success:!0,recommendations:Array.from(c.values()).filter(m=>m.noteId!==e).filter(m=>m.score>=o).sort((m,g)=>g.score-m.score).slice(0,n),sourceNoteId:e}}async addTagBasedRecommendations(t,e){let n=t.tags;if(n.length===0)return;let i=await this.noteRepository.findByTags(n);for(let s of i){if(s.id===t.id)continue;let r=s.tags.filter(c=>n.includes(c)),o=r.length/Math.max(n.length,1),a=e.get(s.id);a?(a.score=Math.max(a.score,o),a.matchedTags=r,a.reasons.some(c=>c.includes("Shared tags"))||a.reasons.push(`Shared tags: ${r.join(", ")}`)):e.set(s.id,{noteId:s.id,title:s.title,filePath:s.filePath,score:o,reasons:[`Shared tags: ${r.join(", ")}`],matchedTags:r})}}async addGraphBasedRecommendations(t,e){let n=await this.graphRepository.findConnectedNodes(t.id);for(let i of n){let s=await this.noteRepository.findById(i.id);if(!s||s.id===t.id)continue;let r=.8,o=e.get(s.id);o?(o.score=Math.max(o.score,r),o.reasons.some(a=>a.includes("Direct link"))||o.reasons.push("Direct link in knowledge graph")):e.set(s.id,{noteId:s.id,title:s.title,filePath:s.filePath,score:r,reasons:["Direct link in knowledge graph"]})}}async addSemanticRecommendations(t,e,n,i){if(this.embeddingService)try{let s=await this.embeddingService.findSimilarNotes(t.id,{limit:i,threshold:n});for(let r of s){if(r.noteId===t.id)continue;let o=await this.noteRepository.findById(r.noteId);if(!o)continue;let a=r.similarity,c=Math.round(a*100),l=e.get(o.id);if(l){let m=Math.min(1,l.score+a*.3);l.score=Math.max(l.score,m),l.reasons.some(g=>g.includes("Semantic"))||l.reasons.push(`Semantic similarity: ${c}%`)}else e.set(o.id,{noteId:o.id,title:o.title,filePath:o.filePath,score:a,reasons:[`Semantic similarity: ${c}%`]})}}catch(s){console.error("Semantic recommendation failed:",s)}}};var V=class{constructor(t,e){this.noteRepository=t;this.graphRepository=e}async execute(t){let{noteId:e,filePath:n,includeLinks:i=!1,includeGraphContext:s=!1,includeStats:r=!1,includeStructure:o=!1}=t,a=e?await this.noteRepository.findById(e):n?await this.noteRepository.findByPath(n):null;if(!a)return{success:!1,error:"Note not found"};let c={noteId:a.id,title:a.title,filePath:a.filePath,tags:a.tags,content:a.content};return i&&a.content&&(c.outgoingLinks=this.extractWikiLinks(a.content)),s&&(c.graphConnections=await this.getGraphConnections(a.id)),r&&a.content&&(c.stats=this.calculateStats(a.content)),o&&a.content&&(c.structure=this.extractStructure(a.content)),{success:!0,context:c}}extractWikiLinks(t){let e=/\[\[([^\]|]+)(?:\|[^\]]+)?\]\]/g,n=[],i;for(;(i=e.exec(t))!==null;){let s=i[1].trim();s&&!n.includes(s)&&n.push(s)}return n}async getGraphConnections(t){return(await this.graphRepository.findConnectedNodes(t)).map(n=>({id:n.id,label:n.label,direction:"outgoing"}))}calculateStats(t){let e=t.split(`
`);return{wordCount:t.split(/\s+/).filter(i=>i.length>0).length,characterCount:t.length,lineCount:e.length}}extractStructure(t){let e=/^(#{1,6})\s+(.+)$/gm,n=[],i;for(;(i=e.exec(t))!==null;)n.push({level:i[1].length,text:i[2].trim()});return{headings:n}}};var Re={similarityThreshold:.5,maxRecommendations:10},B=class{constructor(t,e={}){this.store=t,this.config={...Re,...e}}setConfig(t){this.config={...this.config,...t}}isReady(){return"isAvailable"in this.store?this.store.isAvailable():!0}async findSimilarNotes(t,e){let n=await this.store.get(t);return n?this.store.findSimilar(n.embedding,{limit:e?.limit??this.config.maxRecommendations,threshold:e?.threshold??this.config.similarityThreshold,excludeNoteIds:[t]}):[]}async getStats(){let t=await this.store.getStats(),e="unknown",n="vault-embeddings";if("getSourceInfo"in this.store){let i=this.store.getSourceInfo();i&&(e=i.model,n=i.provider)}return{...t,provider:n,model:e}}async refresh(){"refreshCache"in this.store&&await this.store.refreshCache(!0)}};var Se=["\uC0C1\uC704 \uB9E5\uB77D","\uBCF4\uCDA9 \uC124\uBA85","\uC801\uC6A9 \uC0AC\uB840","\uBE44\uD310 \uAD00\uC810","\uC5F0\uACB0 \uC9C1\uAD00"],Pe=`\uB2F9\uC2E0\uC740 Zettelkasten PKM \uC2DC\uC2A4\uD15C\uC758 \uC5F0\uACB0 \uBD84\uB958 \uC804\uBB38\uAC00\uC785\uB2C8\uB2E4.

\uB450 \uB178\uD2B8 \uC0AC\uC774\uC758 \uAD00\uACC4\uB97C \uBD84\uC11D\uD558\uACE0 \uB2E4\uC74C \uC911 \uD558\uB098\uB85C \uBD84\uB958\uD558\uC138\uC694:
- \uC0C1\uC704 \uB9E5\uB77D: \uB300\uC0C1 \uB178\uD2B8\uAC00 \uC18C\uC2A4 \uB178\uD2B8\uC758 \uB354 \uD070 \uD504\uB808\uC784\uC6CC\uD06C\uB098 \uBC30\uACBD\uC744 \uC81C\uACF5
- \uBCF4\uCDA9 \uC124\uBA85: \uB300\uC0C1 \uB178\uD2B8\uAC00 \uC18C\uC2A4 \uB178\uD2B8\uC758 \uD2B9\uC815 \uCE21\uBA74\uC744 \uBCF4\uCDA9\uD558\uAC70\uB098 \uD655\uC7A5
- \uC801\uC6A9 \uC0AC\uB840: \uB300\uC0C1 \uB178\uD2B8\uAC00 \uC18C\uC2A4 \uB178\uD2B8 \uAC1C\uB150\uC758 \uC2E4\uC81C \uC801\uC6A9 \uC608\uC2DC
- \uBE44\uD310 \uAD00\uC810: \uB300\uC0C1 \uB178\uD2B8\uAC00 \uC18C\uC2A4 \uB178\uD2B8\uC5D0 \uB300\uD55C \uBC18\uB860\uC774\uB098 \uB300\uB9BD \uAD00\uC810 \uC81C\uACF5
- \uC5F0\uACB0 \uC9C1\uAD00: \uD45C\uBA74\uC801 \uAD00\uACC4\uB294 \uC801\uC9C0\uB9CC \uAE4A\uC740 \uAD6C\uC870\uC801 \uC720\uC0AC\uC131\uC774\uB098 \uC9C1\uAD00\uC801 \uC5F0\uACB0 \uC874\uC7AC

\uC751\uB2F5 \uD615\uC2DD (\uBC18\uB4DC\uC2DC JSON\uB9CC \uCD9C\uB825):
{"classification": "\uBD84\uB958\uBA85", "reason": "1-2\uBB38\uC7A5\uC758 \uC5F0\uACB0 \uC0AC\uC720 \uC124\uBA85"}

\uC18C\uC2A4 \uB178\uD2B8 (\uD604\uC7AC \uC791\uC5C5 \uC911\uC778 \uB178\uD2B8):
\uC81C\uBAA9: {{sourceTitle}}
\uB0B4\uC6A9: {{sourceContent}}

\uB300\uC0C1 \uB178\uD2B8 (\uCD94\uCC9C\uB41C \uB178\uD2B8):
\uC81C\uBAA9: {{targetTitle}}
\uB0B4\uC6A9: {{targetContent}}`,le="connection-reasons-cache";var K=class{constructor(t){this.provider=null;this.cache=new Map;this.pendingRequests=new Map;t&&(this.provider=t)}setProvider(t){this.provider=t}isReady(){return this.provider!==null}getCacheKey(t,e){return`${t}:${e}`}getCachedReason(t,e){let n=this.getCacheKey(t,e),i=this.cache.get(n);if(i){let s=new Date(i.createdAt),r=Date.now()-s.getTime(),o=10080*60*1e3;if(r<o)return i.result;this.cache.delete(n)}return null}async generateConnectionReason(t,e,n,i,s,r){if(!this.provider)return this.getDefaultResult();let o=this.getCacheKey(t,i),a=this.getCachedReason(t,i);if(a)return a;let c=this.pendingRequests.get(o);if(c)return c;let l=this.doGenerateReason(e,n,s,r).then(m=>(this.cache.set(o,{sourceNoteId:t,targetNoteId:i,result:m,createdAt:new Date().toISOString()}),this.pendingRequests.delete(o),m)).catch(m=>(console.error("Failed to generate connection reason:",m),this.pendingRequests.delete(o),this.getDefaultResult()));return this.pendingRequests.set(o,l),l}async doGenerateReason(t,e,n,i){if(!this.provider)return this.getDefaultResult();let r={prompt:Pe.replace("{{sourceTitle}}",t).replace("{{sourceContent}}",this.truncateContent(e,800)).replace("{{targetTitle}}",n).replace("{{targetContent}}",this.truncateContent(i,800)),maxTokens:200,temperature:.3},o=await this.provider.generateCompletion(r);return this.parseResponse(o.text)}truncateContent(t,e){let i=t.replace(/^---[\s\S]*?---\n?/,"").replace(/^#+\s+.+$/gm,"").replace(/\[\[([^\]|]+)(?:\|[^\]]+)?\]\]/g,"$1").replace(/\[([^\]]+)\]\([^)]+\)/g,"$1").replace(/[*_~`]/g,"").replace(/\n{3,}/g,`

`).trim();return i.length<=e?i:i.substring(0,e)+"..."}parseResponse(t){try{let e=t.match(/\{[\s\S]*?\}/);if(!e)return console.warn("No JSON found in LLM response:",t),this.getDefaultResult();let n=JSON.parse(e[0]);if(!Se.includes(n.classification))return console.warn("Invalid classification in response:",n.classification),{classification:"\uC5F0\uACB0 \uC9C1\uAD00",reason:n.reason||"\uAD00\uB828 \uC8FC\uC81C\uB85C \uC5F0\uACB0\uB428"};let i=n.reason?.trim();return!i||i.length<5?{classification:n.classification,reason:"\uAD00\uB828 \uC8FC\uC81C\uB85C \uC5F0\uACB0\uB428"}:{classification:n.classification,reason:i.length>200?i.substring(0,197)+"...":i}}catch(e){return console.error("Failed to parse LLM response:",e,t),this.getDefaultResult()}}getDefaultResult(){return{classification:"\uC5F0\uACB0 \uC9C1\uAD00",reason:"\uAD00\uB828 \uC8FC\uC81C\uB85C \uC5F0\uACB0\uB428"}}async saveCache(t){let e=Array.from(this.cache.values()),n=await t.loadData()??{};await t.saveData({...n,[le]:e})}async loadCache(t){let n=(await t.loadData())?.[le];if(!Array.isArray(n))return;let i=10080*60*1e3,s=Date.now();for(let r of n){if(!r.sourceNoteId||!r.targetNoteId||!r.result)continue;let o=new Date(r.createdAt);if(s-o.getTime()>i)continue;let a=this.getCacheKey(r.sourceNoteId,r.targetNoteId);this.cache.set(a,r)}}clearCache(){this.cache.clear(),this.pendingRequests.clear()}getCacheStats(){return{size:this.cache.size,pendingCount:this.pendingRequests.size}}};var A="### \u{1F517} \uC5F0\uACB0\uB41C \uB178\uD2B8",Ee="### \u{1F3F7}\uFE0F \uAD00\uB828 \uD0DC\uADF8",q=class{constructor(t){this.app=t}async execute(t){let{sourceFilePath:e,targetNoteId:n,targetTitle:i,classification:s,reason:r}=t,o=this.app.vault.getAbstractFileByPath(e);if(!o)return{success:!1,message:"\uC18C\uC2A4 \uB178\uD2B8\uB97C \uCC3E\uC744 \uC218 \uC5C6\uC2B5\uB2C8\uB2E4."};if(!this.isTFile(o))return{success:!1,message:"\uC720\uD6A8\uD55C \uB9C8\uD06C\uB2E4\uC6B4 \uD30C\uC77C\uC774 \uC544\uB2D9\uB2C8\uB2E4."};try{let a=await this.app.vault.read(o),l=`- ${`[[${i}]]`} \u2022 ${s} \u2014 ${r}`;if(this.hasExistingLink(a,i))return{success:!1,message:"\uC774\uBBF8 \uC5F0\uACB0\uB41C \uB178\uD2B8\uC785\uB2C8\uB2E4.",alreadyExists:!0};let m=this.addConnectionToContent(a,l);return await this.app.vault.modify(o,m),{success:!0,message:`\uC5F0\uACB0 \uCD94\uAC00\uB428: ${i}`}}catch(a){return console.error("Failed to add connection:",a),{success:!1,message:`\uC5F0\uACB0 \uCD94\uAC00 \uC2E4\uD328: ${a.message}`}}}isTFile(t){return t!==null&&typeof t=="object"&&"path"in t&&"basename"in t&&"extension"in t}hasExistingLink(t,e){let n=e.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");return new RegExp(`\\[\\[${n}(\\|[^\\]]*)?\\]\\]`).test(t)}addConnectionToContent(t,e){let n=t.indexOf(A);return n!==-1?this.insertIntoExistingSection(t,n,e):this.createNewSection(t,e)}insertIntoExistingSection(t,e,n){let i=e+A.length,r=t.substring(i).match(/\n(#{2,3}\s)/),o=r?i+r.index:t.length,a=t.substring(i,o),c=a.match(/^- \[\[.+\]\].*$/gm);if(c&&c.length>0){let l=c[c.length-1],g=t.lastIndexOf(l,o)+l.length;return t.substring(0,g)+`
`+n+t.substring(g)}else{let l=i,g=!(a.match(/^\n*/)?.[0]||"").includes(`

`);return t.substring(0,l)+(g?`

`:`
`)+n+t.substring(l).replace(/^\n+/,`
`)}}createNewSection(t,e){let n=t.indexOf(Ee);if(n!==-1){let s=t.substring(0,n).trimEnd(),r=t.substring(n);return s+`

`+A+`

`+e+`

`+r}let i=t.match(/\n---\s*$/);return i?t.substring(0,i.index).trimEnd()+`

`+A+`

`+e+`

---
`:t.trimEnd()+`

`+A+`

`+e+`
`}};var I=class extends Error{constructor(t){super(t),this.name="InvalidNoteError"}},G=class d{constructor(t){this._id=t.id,this._title=t.title,this._filePath=t.filePath,this._content=t.content,this._tags=this.normalizeTags(t.tags),this._createdAt=t.createdAt,this._updatedAt=t.updatedAt}static create(t){return d.validate(t),new d(t)}static validate(t){if(!t.id)throw new I("Note id is required");if(!t.title)throw new I("Note title is required");if(!t.filePath)throw new I("Note filePath is required")}normalizeTags(t){if(!t)return[];let e=t.map(n=>n.trim().toLowerCase().replace(/^#+/,"")).filter(n=>n.length>0);return[...new Set(e)]}get id(){return this._id}get title(){return this._title}get filePath(){return this._filePath}get content(){return this._content}get tags(){return[...this._tags]}get createdAt(){return this._createdAt}get updatedAt(){return this._updatedAt}equals(t){return this._id===t._id}toPlainObject(){return{id:this._id,title:this._title,filePath:this._filePath,content:this._content,tags:[...this._tags],createdAt:this._createdAt,updatedAt:this._updatedAt}}};function Ce(d){let t=0;for(let e=0;e<d.length;e++){let n=d.charCodeAt(e);t=(t<<5)-t+n,t=t&t}return Math.abs(t).toString(16).padStart(8,"0")}function v(d){let t=d.replace(/\.md$/,"");return Ce(t)}var k=class{constructor(t,e){this.app=t,this.basePath=e}async findById(t){let e=this.findFileById(t);return e?this.fileToNote(e):null}async findByPath(t){let e=this.app.vault.getAbstractFileByPath(t);return!e||!this.isTFile(e)?null:this.fileToNote(e)}async findByTags(t){return(await this.findAll()).filter(n=>{let i=n.tags.map(s=>s.toLowerCase());return t.every(s=>i.includes(s.toLowerCase()))})}async findAll(){let t=this.getNotesInFolder(),e=[];for(let n of t){let i=await this.fileToNote(n);i&&e.push(i)}return e}async findMany(t){let e=await this.findAll();if(t?.tags&&t.tags.length>0&&(e=e.filter(r=>{let o=r.tags.map(a=>a.toLowerCase());return t.tags.some(a=>o.includes(a.toLowerCase()))})),t?.sortBy){let r=t.sortBy,o=t.sortOrder??"desc";e.sort((a,c)=>{let l=a[r],m=c[r];if(l===void 0||m===void 0)return 0;let g=0;return l<m&&(g=-1),l>m&&(g=1),o==="desc"?-g:g})}let n=t?.offset??0,i=t?.limit??e.length;return{items:e.slice(n,n+i),total:e.length,hasMore:n+i<e.length}}async save(t){let e=this.findFileById(t.id),n=this.noteToMarkdown(t);if(e)await this.app.vault.modify(e,n);else{let i=t.filePath||`${this.basePath}/${t.id} ${t.title}.md`;await this.app.vault.create(i,n)}return t}async delete(t){let e=this.findFileById(t);return e?(await this.app.vault.delete(e),!0):!1}async exists(t){return this.findFileById(t)!==null}async count(){return this.getNotesInFolder().length}getNotesInFolder(){return this.app.vault.getFiles().filter(t=>t.path.startsWith(this.basePath)&&t.extension==="md")}findFileById(t){return this.getNotesInFolder().find(n=>v(n.path)===t)??null}isTFile(t){return t!==null&&typeof t=="object"&&"path"in t&&"extension"in t}async fileToNote(t){let e=v(t.path),n=await this.app.vault.read(t),i=this.app.metadataCache.getFileCache(t),s=this.extractTags(n,i);try{return G.create({id:e,title:t.basename,filePath:t.path,content:n,tags:s,createdAt:new Date(t.stat.ctime),updatedAt:new Date(t.stat.mtime)})}catch{return null}}extractTags(t,e){let n=new Set;if(e?.frontmatter?.tags){let s=e.frontmatter.tags;Array.isArray(s)?s.forEach(r=>n.add(String(r).toLowerCase())):typeof s=="string"&&n.add(s.toLowerCase())}e?.tags&&e.tags.forEach(s=>{let r=s.tag.replace(/^#/,"").toLowerCase();n.add(r)});let i=t.match(/^---\n([\s\S]*?)\n---/);if(i){let r=i[1].match(/tags:\s*\n((?:\s+-\s+.+\n?)+)/);r&&r[1].match(/-\s+(.+)/g)?.forEach(a=>{let c=a.replace(/^-\s+/,"").trim().toLowerCase();n.add(c)})}return Array.from(n)}noteToMarkdown(t){let e=["---","tags:",...t.tags.map(i=>`  - ${i}`),`created: ${t.createdAt?.toISOString().split("T")[0]??new Date().toISOString().split("T")[0]}`,"---"].join(`
`),n=t.content??`# ${t.title}

`;return`${e}
${n}`}};var M=class{constructor(t,e){this.commands=new Map;this.app=t,this.plugin=e}register(t){if(this.commands.has(t.id)){console.warn(`Command ${t.id} is already registered`);return}this.commands.set(t.id,t),this.plugin.addCommand({id:t.id,name:t.name,checkCallback:e=>{let n=this.getCurrentContext();if(e)return t.canExecute(n);t.canExecute(n)&&t.execute(n).catch(i=>{console.error(`Command ${t.id} failed:`,i)})}})}unregister(t){this.commands.delete(t)}get(t){return this.commands.get(t)}getAll(){return Array.from(this.commands.values())}getByCategory(t){return this.getAll().filter(e=>e.getMetadata().category===t)}registerAll(t){for(let e of t)this.register(e)}getCurrentContext(){let t=this.app.workspace.getActiveFile();return{currentNoteId:t?this.extractNoteId(t):void 0,currentNotePath:t?.path??"",selection:this.getActiveSelection(),metadata:{triggeredAt:Date.now(),source:"obsidian-command"}}}extractNoteId(t){return v(t.path)}getActiveSelection(){let t=this.app.workspace.getActiveViewOfType(this.app.workspace.constructor.MarkdownView);if(t&&"editor"in t)return t.editor.getSelection()||void 0}};var u=require("obsidian");Y();var ge={provider:"openai",openaiApiKey:"",geminiApiKey:"",anthropicApiKey:"",semanticThreshold:.5},J={zettelkastenFolder:"04_Zettelkasten",maxRecommendations:5,minScore:.3,useGraphConnections:!0,useTagSimilarity:!0,useSemanticSimilarity:!0,autoShowRecommendations:!1,showInSidebar:!0,debugMode:!1,llm:ge},D=class{constructor(t){this.plugin=t,this.settings={...J}}async loadSettings(){let t=await this.plugin.loadData();t&&(this.settings={...J,...t})}getSettings(){return{...this.settings}}async updateSettings(t){this.settings={...this.settings,...t},await this.plugin.saveData(this.settings)}async resetToDefaults(){this.settings={...J},await this.plugin.saveData(this.settings)}},O=class extends u.PluginSettingTab{constructor(t,e,n){super(t,e),this.settingsAdapter=n}display(){let{containerEl:t}=this,e=this.settingsAdapter.getSettings();t.empty(),t.createEl("h2",{text:"PKM Note Recommender Settings"}),this.buildGeneralSection(t,e),this.buildRecommendationSection(t,e),this.buildAlgorithmSection(t,e),this.buildAIProviderSection(t,e),this.buildDisplaySection(t,e),this.buildAdvancedSection(t,e)}buildGeneralSection(t,e){this.createSectionHeader(t,"General","Basic plugin configuration"),new u.Setting(t).setName("Zettelkasten folder").setDesc("The folder containing your permanent notes (YYYYMMDDHHMM format)").addText(n=>n.setPlaceholder("04_Zettelkasten").setValue(e.zettelkastenFolder).onChange(async i=>{await this.settingsAdapter.updateSettings({zettelkastenFolder:i})}))}buildRecommendationSection(t,e){this.createSectionHeader(t,"Recommendation Settings","Control how recommendations are generated"),new u.Setting(t).setName("Maximum recommendations").setDesc("Maximum number of note recommendations to show").addText(n=>n.setPlaceholder("5").setValue(String(e.maxRecommendations)).onChange(async i=>{let s=parseInt(i,10);!isNaN(s)&&s>0&&await this.settingsAdapter.updateSettings({maxRecommendations:s})})),new u.Setting(t).setName("Minimum score threshold").setDesc("Only show recommendations above this score (0-100%)").addText(n=>n.setPlaceholder("30").setValue(String(Math.round(e.minScore*100))).onChange(async i=>{let s=parseInt(i,10);!isNaN(s)&&s>=0&&s<=100&&await this.settingsAdapter.updateSettings({minScore:s/100})}))}buildAlgorithmSection(t,e){this.createSectionHeader(t,"Algorithm Settings","Configure recommendation algorithms"),new u.Setting(t).setName("Use graph connections").setDesc("Include linked notes in recommendations").addToggle(n=>n.setValue(e.useGraphConnections).onChange(async i=>{await this.settingsAdapter.updateSettings({useGraphConnections:i})})),new u.Setting(t).setName("Use tag similarity").setDesc("Include notes with similar tags in recommendations").addToggle(n=>n.setValue(e.useTagSimilarity).onChange(async i=>{await this.settingsAdapter.updateSettings({useTagSimilarity:i})})),new u.Setting(t).setName("Use semantic similarity").setDesc("Use AI embeddings to find semantically similar notes (requires API key)").addToggle(n=>n.setValue(e.useSemanticSimilarity).onChange(async i=>{await this.settingsAdapter.updateSettings({useSemanticSimilarity:i})}))}buildAIProviderSection(t,e){this.createSectionHeader(t,"AI Provider Settings","Configure AI provider for connection reasons. Note: Embeddings are provided by Vault Embeddings plugin."),new u.Setting(t).setName("AI Provider").setDesc("Select which AI provider to use for generating connection reasons").addDropdown(s=>s.addOption("openai","OpenAI (recommended)").addOption("gemini","Google Gemini").addOption("anthropic","Anthropic (Voyage AI)").setValue(e.llm.provider).onChange(async r=>{await this.settingsAdapter.updateSettings({llm:{...e.llm,provider:r}}),this.display()}));let n=ae[e.llm.provider],i=this.getApiKeyForProvider(e);new u.Setting(t).setName(`${n.name} API Key`).setDesc(`Get your API key from: ${n.docsUrl}`).addText(s=>s.setPlaceholder(n.keyPlaceholder).setValue(i).onChange(async r=>{let o={...e.llm};switch(e.llm.provider){case"openai":o.openaiApiKey=r;break;case"gemini":o.geminiApiKey=r;break;case"anthropic":o.anthropicApiKey=r;break}await this.settingsAdapter.updateSettings({llm:o})})).addButton(s=>s.setButtonText("Test").onClick(()=>this.testApiKey())),new u.Setting(t).setName("Semantic similarity threshold").setDesc("Minimum similarity score for semantic recommendations (0-100%)").addText(s=>s.setPlaceholder("50").setValue(String(Math.round(e.llm.semanticThreshold*100))).onChange(async r=>{let o=parseInt(r,10);!isNaN(o)&&o>=0&&o<=100&&await this.settingsAdapter.updateSettings({llm:{...e.llm,semanticThreshold:o/100}})})),t.createEl("p",{text:"Embeddings are managed by the Vault Embeddings plugin. Use its settings to configure embedding generation.",cls:"setting-item-description"})}buildDisplaySection(t,e){this.createSectionHeader(t,"Display Settings","Configure how recommendations are shown"),new u.Setting(t).setName("Auto-show recommendations").setDesc("Automatically show recommendations when opening a note").addToggle(n=>n.setValue(e.autoShowRecommendations).onChange(async i=>{await this.settingsAdapter.updateSettings({autoShowRecommendations:i})})),new u.Setting(t).setName("Show in sidebar").setDesc("Display recommendations in a sidebar panel").addToggle(n=>n.setValue(e.showInSidebar).onChange(async i=>{await this.settingsAdapter.updateSettings({showInSidebar:i})}))}buildAdvancedSection(t,e){this.createSectionHeader(t,"Advanced","Advanced options and debugging"),new u.Setting(t).setName("Debug mode").setDesc("Log additional debugging information to the console").addToggle(n=>n.setValue(e.debugMode).onChange(async i=>{await this.settingsAdapter.updateSettings({debugMode:i})})),new u.Setting(t).setName("Reset to defaults").setDesc("Reset all settings to their default values").addButton(n=>n.setButtonText("Reset").onClick(async()=>{await this.settingsAdapter.resetToDefaults(),this.display()}))}createSectionHeader(t,e,n){t.createEl("h3",{text:e}),n&&t.createEl("p",{text:n,cls:"setting-item-description"})}getApiKeyForProvider(t){switch(t.llm.provider){case"openai":return t.llm.openaiApiKey;case"gemini":return t.llm.geminiApiKey;case"anthropic":return t.llm.anthropicApiKey;default:return""}}async testApiKey(){let t=this.settingsAdapter.getSettings(),e=this.getApiKeyForProvider(t);if(!e){new u.Notice("Please enter an API key first");return}if(!de(t.llm.provider,e)){new u.Notice("API key format looks incorrect");return}new u.Notice("Testing API key...");try{let{createLLMProvider:n}=await Promise.resolve().then(()=>(Y(),ue));await n(t.llm.provider,{apiKey:e}).validateApiKey()?new u.Notice("API key is valid!"):new u.Notice("API key is invalid. Please check your key.")}catch(n){console.error("API key test failed:",n),new u.Notice(`API key test failed: ${n.message}`)}}};var P=require("obsidian");function pe(d,t){if(d.length!==t.length)throw new Error(`Vector dimensions must match: ${d.length} vs ${t.length}`);let e=0,n=0,i=0;for(let r=0;r<d.length;r++)e+=d[r]*t[r],n+=d[r]*d[r],i+=t[r]*t[r];let s=Math.sqrt(n)*Math.sqrt(i);return s===0?0:e/s}var Ve={storagePath:"09_Embedded",embeddingsFolder:"embeddings"},Z=class{constructor(t,e){this.cache=new Map;this.indexCache=null;this.lastCacheUpdate=0;this.CACHE_TTL_MS=6e4;this.app=t,this.config={...Ve,...e}}async initialize(){await this.refreshCache()}async refreshCache(t=!1){let e=Date.now();if(!t&&e-this.lastCacheUpdate<this.CACHE_TTL_MS)return;this.cache.clear(),this.indexCache=null;let n=await this.loadIndex();if(!n){console.warn("VaultEmbeddingsReader: No index.json found. Is Vault Embeddings plugin installed?");return}this.indexCache=n;for(let i of Object.keys(n.notes)){let s=await this.loadEmbedding(i);s&&this.cache.set(i,s)}this.lastCacheUpdate=e,console.info(`VaultEmbeddingsReader: Loaded ${this.cache.size} embeddings from Vault Embeddings`)}async get(t){return await this.refreshCache(),this.cache.get(t)??null}async exists(t){return await this.refreshCache(),this.cache.has(t)}async isStale(t,e){await this.refreshCache();let n=this.cache.get(t);return n?n.contentHash!==e:!0}async getAll(){return await this.refreshCache(),Array.from(this.cache.values())}async findSimilar(t,e){await this.refreshCache();let n=e?.limit??10,i=e?.threshold??.5,s=new Set(e?.excludeNoteIds??[]),r=[];for(let o of this.cache.values()){if(s.has(o.noteId))continue;let a=pe(t,o.embedding);a>=i&&r.push({noteId:o.noteId,notePath:o.notePath,similarity:a})}return r.sort((o,a)=>a.similarity-o.similarity).slice(0,n)}async getStats(){await this.refreshCache();let t=this.indexCache,e=this.estimateStorageSize();return{totalEmbeddings:this.cache.size,lastUpdated:t?.lastUpdated?new Date(t.lastUpdated):null,storageSize:e}}async save(t){console.info("VaultEmbeddingsReader: save() is no-op. Use Vault Embeddings plugin to manage embeddings.")}async saveBatch(t){console.info("VaultEmbeddingsReader: saveBatch() is no-op. Use Vault Embeddings plugin to manage embeddings.")}async delete(t){console.info("VaultEmbeddingsReader: delete() is no-op. Use Vault Embeddings plugin to manage embeddings.")}async clear(){console.info("VaultEmbeddingsReader: clear() is no-op. Use Vault Embeddings plugin to manage embeddings.")}async flush(){}getIndexPath(){return(0,P.normalizePath)(`${this.config.storagePath}/index.json`)}getEmbeddingPath(t){let e=t.replace(/[^a-zA-Z0-9-_]/g,"_");return(0,P.normalizePath)(`${this.config.storagePath}/${this.config.embeddingsFolder}/${e}.json`)}async loadIndex(){let t=this.getIndexPath(),e,n=this.app.vault.getAbstractFileByPath(t);if(n instanceof P.TFile)e=await this.app.vault.read(n);else try{e=await this.app.vault.adapter.read(t),console.log("VaultEmbeddingsReader: Used adapter.read for index")}catch{return null}try{return JSON.parse(e)}catch{return console.error("VaultEmbeddingsReader: Failed to parse index.json"),null}}async loadEmbedding(t){let e=this.getEmbeddingPath(t),n,i=this.app.vault.getAbstractFileByPath(e);if(i instanceof P.TFile)n=await this.app.vault.read(i);else try{n=await this.app.vault.adapter.read(e)}catch{return null}try{let s=JSON.parse(n);return{noteId:s.noteId,notePath:s.notePath,embedding:s.vector,model:s.model,provider:s.provider,createdAt:new Date(s.createdAt),contentHash:s.contentHash}}catch{return console.error(`VaultEmbeddingsReader: Failed to parse embedding ${t}`),null}}estimateStorageSize(){let t=0;for(let e of this.cache.values())t+=e.noteId.length*2,t+=e.notePath.length*2,t+=e.embedding.length*8,t+=200;return t}async isAvailable(){let t=this.getIndexPath();if(this.app.vault.getAbstractFileByPath(t)instanceof P.TFile)return!0;try{return await this.app.vault.adapter.exists(t)}catch{return!1}}getSourceInfo(){return this.indexCache?{model:this.indexCache.model,dimensions:this.indexCache.dimensions,provider:"vault-embeddings"}:null}};Y();var E=require("obsidian");var T="pkm-recommendations-view",$=class extends E.ItemView{constructor(e,n,i,s,r,o){super(e);this.isLoading=!1;this.state={sourceNoteId:null,sourceFilePath:null,sourceTitle:null,sourceContent:null,recommendations:[]};this.recommendNotesUseCase=n,this.settings=i,this.onStatusChange=s,this.connectionReasonService=r??null,this.addConnectionUseCase=o??null}getViewType(){return T}getDisplayText(){return"Note Recommendations"}getIcon(){return"lightbulb"}async onOpen(){let e=this.containerEl.children[1];e.empty(),e.addClass("pkm-recommendations-container");let n=e.createEl("div",{cls:"pkm-recommendations-header"});n.createEl("h4",{text:"Related Notes"});let i=n.createEl("button",{cls:"pkm-refresh-btn"});i.setText("\u21BB"),i.setAttribute("aria-label","Refresh recommendations"),i.addEventListener("click",()=>this.refresh()),e.createEl("div",{cls:"pkm-recommendations-content"}),await this.refresh()}async onClose(){}async refresh(){if(this.isLoading)return;let e=this.containerEl.querySelector(".pkm-recommendations-content");if(!e)return;this.isLoading=!0,this.onStatusChange?.("loading"),e.empty();let n=this.app.workspace.getActiveFile();if(!n){this.showMessage(e,"No note is currently open"),this.isLoading=!1,this.onStatusChange?.("ready");return}let i=this.extractNoteId(n);try{let s=await this.app.vault.cachedRead(n);this.state.sourceNoteId=i,this.state.sourceFilePath=n.path,this.state.sourceTitle=n.basename,this.state.sourceContent=s}catch{this.showMessage(e,"Failed to read current note"),this.isLoading=!1,this.onStatusChange?.("error");return}this.showMessage(e,"Loading recommendations...");try{let s=await this.recommendNotesUseCase.execute({sourceNoteId:i,maxResults:this.settings.maxRecommendations,useGraphConnections:this.settings.useGraphConnections,useSemanticSimilarity:this.settings.useSemanticSimilarity,semanticThreshold:this.settings.llm.semanticThreshold,minScore:this.settings.minScore});if(e.empty(),!s.success){this.showMessage(e,`Error: ${s.error}`),this.onStatusChange?.("error");return}if(s.recommendations.length===0){this.showMessage(e,"No related notes found."),this.onStatusChange?.(0);return}this.state.recommendations=s.recommendations.map(r=>({...r,connectionStatus:"pending",isAdded:!1})),this.renderRecommendations(e),this.onStatusChange?.(s.recommendations.length),this.connectionReasonService?.isReady()&&this.loadConnectionReasons()}catch(s){console.error("Failed to get recommendations:",s),this.showMessage(e,"Failed to load recommendations"),this.onStatusChange?.("error")}finally{this.isLoading=!1}}extractNoteId(e){return v(e.path)}showMessage(e,n){e.empty(),e.createEl("div",{cls:"pkm-recommendations-message"}).setText(n)}async loadConnectionReasons(){if(!(!this.connectionReasonService||!this.state.sourceContent))for(let e=0;e<this.state.recommendations.length;e++){let n=this.state.recommendations[e],i=this.connectionReasonService.getCachedReason(this.state.sourceNoteId,n.noteId);if(i){this.state.recommendations[e]={...n,connection:i,connectionStatus:"ready"},this.updateItemUI(e);continue}this.state.recommendations[e]={...n,connectionStatus:"loading"},this.updateItemUI(e);try{let s=await this.loadNoteContent(n.noteId);if(!s){this.state.recommendations[e]={...n,connectionStatus:"error"},this.updateItemUI(e);continue}let r=await this.connectionReasonService.generateConnectionReason(this.state.sourceNoteId,this.state.sourceTitle,this.state.sourceContent,n.noteId,n.title,s);this.state.recommendations[e]={...n,connection:r,connectionStatus:"ready"},this.updateItemUI(e)}catch(s){console.error(`Failed to load connection reason for ${n.noteId}:`,s),this.state.recommendations[e]={...n,connectionStatus:"error"},this.updateItemUI(e)}}}async loadNoteContent(e){let i=this.app.vault.getFiles().find(s=>s.basename.startsWith(e));if(!i)return null;try{return await this.app.vault.cachedRead(i)}catch{return null}}renderRecommendations(e){let n=e.createEl("ul",{cls:"pkm-recommendations-list"});for(let i=0;i<this.state.recommendations.length;i++)this.renderRecommendationItem(n,i)}renderRecommendationItem(e,n){let i=this.state.recommendations[n],s=e.createEl("li",{cls:"pkm-recommendation-item",attr:{"data-index":n.toString()}}),r=s.createEl("div",{cls:"pkm-recommendation-header"});r.createEl("a",{cls:"pkm-recommendation-title",text:i.title}).addEventListener("click",()=>this.openNote(i.noteId));let a=r.createEl("span",{cls:"pkm-recommendation-score",text:`${Math.round(i.score*100)}%`});if(this.applyScoreStyle(a,i.score),this.addConnectionUseCase){let l=r.createEl("button",{cls:i.isAdded?"pkm-add-connection-btn pkm-add-btn-disabled":"pkm-add-connection-btn",text:i.isAdded?"\u2713":"+",attr:{"aria-label":"\uC5F0\uACB0 \uCD94\uAC00","data-index":n.toString()}});i.isAdded?l.disabled=!0:l.addEventListener("click",()=>this.handleAddConnection(n))}let c=s.createEl("div",{cls:"pkm-recommendation-connection"});if(this.renderConnectionStatus(c,i),i.reasons.length>0&&i.connectionStatus!=="ready"){let l=s.createEl("div",{cls:"pkm-recommendation-reasons"});for(let m of i.reasons)l.createEl("span",{cls:"pkm-recommendation-reason",text:m})}}renderConnectionStatus(e,n){switch(e.empty(),n.connectionStatus){case"loading":e.addClass("pkm-connection-loading"),e.createEl("span",{cls:"pkm-connection-spinner",text:"\uBD84\uC11D \uC911..."});break;case"ready":e.removeClass("pkm-connection-loading"),n.connection&&(e.createEl("span",{cls:`pkm-classification-badge pkm-classification-${this.getClassificationClass(n.connection.classification)}`,text:n.connection.classification}),e.createEl("span",{cls:"pkm-connection-reason-text",text:n.connection.reason}));break;case"error":e.removeClass("pkm-connection-loading"),e.createEl("span",{cls:"pkm-connection-error",text:"\uBD84\uB958 \uC2E4\uD328"});break;case"pending":break}}getClassificationClass(e){return{"\uC0C1\uC704 \uB9E5\uB77D":"context","\uBCF4\uCDA9 \uC124\uBA85":"supplementary","\uC801\uC6A9 \uC0AC\uB840":"application","\uBE44\uD310 \uAD00\uC810":"critical","\uC5F0\uACB0 \uC9C1\uAD00":"intuitive"}[e]||"default"}updateItemUI(e){let n=this.containerEl.querySelector(`[data-index="${e}"]`);if(!n)return;let i=this.state.recommendations[e],s=n.querySelector(".pkm-recommendation-connection");s&&this.renderConnectionStatus(s,i);let r=n.querySelector(".pkm-add-connection-btn");r&&i.isAdded&&(r.disabled=!0,r.addClass("pkm-add-btn-disabled"),r.setText("\u2713"));let o=n.querySelector(".pkm-recommendation-reasons");o&&i.connectionStatus==="ready"&&o.addClass("pkm-reasons-hidden")}async handleAddConnection(e){if(!this.addConnectionUseCase||!this.state.sourceFilePath){new E.Notice("\uC5F0\uACB0 \uCD94\uAC00 \uAE30\uB2A5\uC744 \uC0AC\uC6A9\uD560 \uC218 \uC5C6\uC2B5\uB2C8\uB2E4.");return}let n=this.state.recommendations[e],i=n.connection?.classification??"\uC5F0\uACB0 \uC9C1\uAD00",s=n.connection?.reason??"\uAD00\uB828 \uC8FC\uC81C\uB85C \uC5F0\uACB0\uB428";try{let r=await this.addConnectionUseCase.execute({sourceFilePath:this.state.sourceFilePath,targetNoteId:n.noteId,targetTitle:n.title,classification:i,reason:s});r.success?(new E.Notice(r.message),this.state.recommendations[e]={...n,isAdded:!0},this.updateItemUI(e)):new E.Notice(r.message)}catch(r){console.error("Failed to add connection:",r),new E.Notice("\uC5F0\uACB0 \uCD94\uAC00 \uC2E4\uD328")}}applyScoreStyle(e,n){n>=.7?e.addClass("pkm-score-high"):n>=.4?e.addClass("pkm-score-medium"):e.addClass("pkm-score-low")}async openNote(e){let i=this.app.vault.getFiles().find(s=>s.basename.startsWith(e));i&&await this.app.workspace.getLeaf().openFile(i)}};var X=class extends y.Plugin{constructor(){super(...arguments);this.vaultEmbeddingsReader=null;this.vaultEmbeddingService=null;this.addConnectionUseCase=null;this.statusBarItem=null}async onload(){console.info("Loading PKM Note Recommender plugin"),await this.initializeSettings(),this.initializeAdapters(),this.initializeUseCases(),await this.initializeEmbeddingService(),await this.initializeConnectionServices(),this.registerView(T,e=>new $(e,this.recommendNotesUseCase,this.settings,n=>this.updateStatusBar(n),this.connectionReasonService,this.addConnectionUseCase)),this.registerCommands(),this.registerEventHandlers(),this.addRibbonIcon("lightbulb","Show Note Recommendations",()=>{this.activateView()}),this.statusBarItem=this.addStatusBarItem(),this.updateStatusBar("ready"),this.addSettingTab(new O(this.app,this,this.settingsAdapter))}async onunload(){console.info("Unloading PKM Note Recommender plugin"),this.connectionReasonService&&await this.connectionReasonService.saveCache(this)}async initializeSettings(){this.settingsAdapter=new D(this),await this.settingsAdapter.loadSettings(),this.settings=this.settingsAdapter.getSettings()}initializeAdapters(){this.vaultAdapter=new k(this.app,this.settings.zettelkastenFolder),this.commandAdapter=new M(this.app,this)}initializeUseCases(){let e={findNodeById:async()=>null,findConnectedNodes:async()=>[],findNodesByTags:async()=>[],findNodes:async()=>[],getAllNodes:async()=>[],getAllEdges:async()=>[],getStats:async()=>({nodeCount:0,edgeCount:0,averageDegree:0,maxDegree:0,generatedAt:new Date}),saveNode:async()=>{throw new Error("NullGraphRepository: Cannot save nodes")},addEdge:async()=>!1,removeEdge:async()=>!1,deleteNode:async()=>!1,nodeExists:async()=>!1,reload:async()=>{}};this.recommendNotesUseCase=new U(this.vaultAdapter,e),this.getNoteContextUseCase=new V(this.vaultAdapter,e)}async initializeEmbeddingService(){if(!this.settings.useSemanticSimilarity){console.info("Semantic similarity disabled, skipping embedding service initialization");return}try{if(this.vaultEmbeddingsReader=new Z(this.app,{storagePath:"09_Embedded",embeddingsFolder:"embeddings"}),await this.vaultEmbeddingsReader.initialize(),!this.vaultEmbeddingsReader.isAvailable()){console.warn('Vault Embeddings not available. Install Vault Embeddings plugin and run "Embed All Notes".');return}this.vaultEmbeddingService=new B(this.vaultEmbeddingsReader,{similarityThreshold:this.settings.llm.semanticThreshold,maxRecommendations:this.settings.maxRecommendations}),this.recommendNotesUseCase.setEmbeddingService(this.vaultEmbeddingService);let e=await this.vaultEmbeddingService.getStats();console.info(`Vault Embedding service initialized: ${e.totalEmbeddings} embeddings from ${e.model}`)}catch(e){console.error("Failed to initialize embedding service:",e)}}async initializeConnectionServices(){this.connectionReasonService=new K,await this.connectionReasonService.loadCache(this);let e=this.getApiKeyForProvider();if(e&&this.settings.useSemanticSimilarity)try{let n=W(this.settings.llm.provider,{apiKey:e});this.connectionReasonService.setProvider(n),console.info("ConnectionReasonService initialized with LLM provider")}catch(n){console.error("Failed to initialize ConnectionReasonService LLM provider:",n)}this.addConnectionUseCase=new q(this.app),console.info("AddConnectionUseCase initialized")}getApiKeyForProvider(){switch(this.settings.llm.provider){case"openai":return this.settings.llm.openaiApiKey;case"gemini":return this.settings.llm.geminiApiKey;case"anthropic":return this.settings.llm.anthropicApiKey;default:return""}}async reinitializeEmbeddingService(){this.vaultEmbeddingService=null,this.vaultEmbeddingsReader=null,this.recommendNotesUseCase.setEmbeddingService(null),await this.initializeEmbeddingService();let e=this.getApiKeyForProvider();if(e&&this.settings.useSemanticSimilarity)try{let n=W(this.settings.llm.provider,{apiKey:e});this.connectionReasonService.setProvider(n)}catch(n){console.error("Failed to reinitialize ConnectionReasonService LLM provider:",n),this.connectionReasonService.setProvider(null)}else this.connectionReasonService.setProvider(null)}registerCommands(){this.addCommand({id:"pkm-show-recommendations",name:"Show note recommendations",callback:()=>{this.activateView()}}),this.addCommand({id:"pkm-refresh-recommendations",name:"Refresh note recommendations",callback:()=>{this.refreshRecommendations()}}),this.addCommand({id:"pkm-refresh-embeddings",name:"Refresh embeddings from Vault Embeddings",callback:()=>{this.refreshEmbeddings()}}),this.addCommand({id:"pkm-embedding-stats",name:"Show embedding statistics",callback:()=>{this.showEmbeddingStats()}})}async refreshEmbeddings(){if(!this.vaultEmbeddingService){new y.Notice("Vault Embeddings not available. Install Vault Embeddings plugin first.");return}try{await this.vaultEmbeddingService.refresh();let e=await this.vaultEmbeddingService.getStats();new y.Notice(`Embeddings refreshed: ${e.totalEmbeddings} embeddings loaded`)}catch(e){console.error("Failed to refresh embeddings:",e),new y.Notice(`Failed to refresh embeddings: ${e.message}`)}}async showEmbeddingStats(){if(!this.vaultEmbeddingService){new y.Notice("Vault Embeddings not available. Install Vault Embeddings plugin first.");return}try{let e=await this.vaultEmbeddingService.getStats();new y.Notice(`Embedding Statistics (from Vault Embeddings):
Source: ${e.provider}
Model: ${e.model}
Total embeddings: ${e.totalEmbeddings}
Storage size: ${(e.storageSize/1024).toFixed(1)}KB`)}catch(e){console.error("Failed to get embedding stats:",e),new y.Notice(`Failed to get stats: ${e.message}`)}}registerEventHandlers(){this.settings.autoShowRecommendations&&this.registerEvent(this.app.workspace.on("file-open",e=>{e&&this.isValidNoteFile(e.path)&&this.refreshRecommendations()}))}isValidNoteFile(e){return e.startsWith(this.settings.zettelkastenFolder)&&e.endsWith(".md")&&/^\d{12}/.test(e.split("/").pop()??"")}async activateView(){let{workspace:e}=this.app,n=null,i=e.getLeavesOfType(T);i.length>0?n=i[0]:(n=e.getRightLeaf(!1),n&&await n.setViewState({type:T,active:!0})),n&&(e.revealLeaf(n),this.refreshRecommendations())}refreshRecommendations(){let e=this.app.workspace.getLeavesOfType(T);for(let n of e){let i=n.view;i instanceof $&&i.refresh()}}updateStatusBar(e){if(!this.statusBarItem)return;let n,i;switch(e){case"ready":n="\u{1F4A1} PKM",i="PKM Note Recommender - Ready";break;case"loading":n="\u{1F4A1} ...",i="PKM Note Recommender - Loading recommendations...";break;case"error":n="\u{1F4A1} \u26A0\uFE0F",i="PKM Note Recommender - Error loading recommendations";break;default:n=`\u{1F4A1} ${e}`,i=`PKM Note Recommender - ${e} related notes found`;break}this.statusBarItem.setText(n),this.statusBarItem.setAttribute("aria-label",i)}};
